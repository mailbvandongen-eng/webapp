<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Detectorkaart V2 – bvd 8.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="madelinus.png" />

  <!-- Light mode force -->
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ============================================================
   BASIC LIGHT MODE
============================================================ */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #ffffff;
  font-family: system-ui, sans-serif;
}

#app, #map {
  width: 100vw;
  height: 100vh;
  position: relative;
}

/* ============================================================
   GENERIC CONTROL BUTTON (GPS / Layers / Opacity / Rotate / Compass)
============================================================ */
.control-button {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  background: #ffffff;
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
  z-index: 9999;
}

.control-button:hover {
  background: #f3f4f6;
}

.control-button .icon {
  width: 22px;
  height: 22px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 22px 22px;
}

/* ============================================================
   GPS KNOP – linksboven
============================================================ */
#gps-toggle {
  position: absolute;
  left: 10px;
  top: 10px;
}

/* icoontjes */
#gps-toggle .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%236b7280' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%232563EB' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on {
  box-shadow: 0 0 6px rgba(37,99,235,0.55);
}

/* ============================================================
   LAYER CONTROL (rechtsboven)
============================================================ */
.leaflet-top.leaflet-right {
  top: 10px !important;
  right: 10px !important;
}

.leaflet-control-layers-toggle {
  width: 38px !important;
  height: 38px !important;
  border-radius: 10px !important;
  background-color: #ffffff !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22) !important;

  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%23111827' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 8L12 4L20 8L12 12L4 8Z'/%3E%3Cpath d='M4 12L12 16L20 12' fill='none' stroke='%23111827' stroke-width='1.4'/%3E%3Cpath d='M4 16L12 20L20 16' fill='none' stroke='%23111827' stroke-width='1.4'/%3E%3C/svg%3E") !important;
  background-position: center !important;
  background-repeat: no-repeat !important;
  background-size: 22px 22px !important;
}

/* ============================================================
   COMPASS BUTTON — onder lagen-knop
============================================================ */
#compass-indicator {
  position: absolute;
  right: 10px;
  top: 58px;
  width: 38px;
  height: 38px;
  border-radius: 10px;
  background: #ffffff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#compass-indicator .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24'
  xmlns='http://www.w3.org/2000/svg'%3E
  %3Cpath d='M12 3L14 9L12 7L10 9L12 3Z' fill='%23e11d48'/%3E
  %3Ccircle cx='12' cy='14' r='6' stroke='%23111827' stroke-width='1.4' fill='none'/%3E
  %3C/svg%3E");
}

/* Hidden class */
.hidden { display: none; }

/* ============================================================
   OPACITY TOGGLE (rechtsonder)
============================================================ */
#opacity-toggle {
  position: absolute;
  right: 10px;
  bottom: 80px;
}

/* ============================================================
   ROTATE BUTTON (boven opacity)
============================================================ */
#rotate-toggle {
  position: absolute;
  right: 10px;
  bottom: 130px;
}

#rotate-toggle.rotate-on {
  background: #e0ecff;
  box-shadow: 0 0 6px rgba(37,99,235,0.45);
}

#rotate-toggle .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24'
  xmlns='http://www.w3.org/2000/svg' fill='%23111827'%3E
  %3Ccircle cx='12' cy='12' r='9' stroke='%23111827' stroke-width='1.4' fill='none'/%3E
  %3Cpath d='M12 3L14 7H10L12 3Z'/%3E
  %3C/svg%3E");
}

/* ============================================================
   BUILD LABEL
============================================================ */
.build-label {
  position: absolute;
  left: 10px;
  bottom: 80px;
  font-size: 10px;
  color: #6b7280;
  background: rgba(255,255,255,0.9);
  padding: 3px 8px;
  border-radius: 999px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}
</style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <!-- GPS -->
  <button id="gps-toggle" class="control-button"><div class="icon"></div></button>

  <!-- Compass under layer button -->
  <div id="compass-indicator" class="control-button hidden">
    <div class="icon"></div>
  </div>

  <!-- Rotate button -->
  <button id="rotate-toggle" class="control-button"><div class="icon"></div></button>

  <!-- Opacity toggle -->
  <button id="opacity-toggle" class="control-button"><div class="icon"></div></button>

  <div class="build-label">bvd 8.7</div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
console.log("BVD 8.7 geladen");

/* ============================================================
   MAP INIT
============================================================ */
const map = L.map("map", { zoomControl:false }).setView([52.07,4.35], 13);
const mapPane = map.getPane("mapPane");

L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19 }
).addTo(map);

/* ============================================================
   GPS + CONE (Google-sized)
============================================================ */
let tracking = false;
let firstJumpDone = false;
let heading = null;
let smoothHeading = null;

let gpsMarker = L.circleMarker([52.07,4.35], {
  radius: 10,
  color: "#ffffff",
  weight: 2,
  fillColor: "#1a73e8",
  fillOpacity: 1
}).addTo(map);

let gpsAccuracy = L.circle([52.07,4.35], {
  radius: 0,
  color: "#1a73e8",
  fillOpacity: 0.15,
  weight: 1
}).addTo(map);

let directionCone = L.polygon([], {
  color: "#1a73e8",
  fillColor: "#1a73e8",
  fillOpacity: 0.22,
  weight: 0
}).addTo(map);

function updateSmoothHeading(h) {
  if (smoothHeading == null) { smoothHeading = h; return; }
  smoothHeading = smoothHeading * 0.9 + h * 0.1;
}

function drawCone(latlng, hdg) {
  if (!hdg) return;

  const near = 24, far = 85, len = 110; // Google-achtige proporties
  const base = map.latLngToLayerPoint(latlng);

  const r = (d)=>d*Math.PI/180;
  const a = r(hdg - 90);
  const fwd = L.point(Math.cos(a), Math.sin(a));

  const A = base.add(L.point(-fwd.y, fwd.x).multiplyBy(near/2));
  const B = base.add(L.point( fwd.y,-fwd.x).multiplyBy(near/2));
  const C = base.add(fwd.multiplyBy(len).add(L.point(-fwd.y, fwd.x).multiplyBy(far/2)));
  const D = base.add(fwd.multiplyBy(len).add(L.point( fwd.y,-fwd.x).multiplyBy(far/2)));

  directionCone.setLatLngs([
    map.layerPointToLatLng(A),
    map.layerPointToLatLng(C),
    map.layerPointToLatLng(D),
    map.layerPointToLatLng(B)
  ]);
}

function updateGps(latlng, acc) {
  gpsMarker.setLatLng(latlng);
  gpsAccuracy.setLatLng(latlng);
  gpsAccuracy.setRadius(acc);

  if (smoothHeading != null) drawCone(latlng, smoothHeading);
}

map.on("locationfound", e => {
  if (!tracking) return;

  updateGps(e.latlng, e.accuracy);

  if (!firstJumpDone) {
    map.setView(e.latlng, Math.max(map.getZoom(),16), { animate:true });
    firstJumpDone = true;
  }
});

/* ============================================================
   DEVICE ORIENTATION → heading
============================================================ */
if (window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientationabsolute", ev => {
    if (ev.alpha != null) updateSmoothHeading(360 - ev.alpha);
  });
  window.addEventListener("deviceorientation", ev => {
    if (ev.webkitCompassHeading) updateSmoothHeading(ev.webkitCompassHeading);
  });
}
/* ============================================================
   GPS BUTTON
============================================================ */
const gpsBtn = document.getElementById("gps-toggle");

gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);

  if (tracking) {
    firstJumpDone = false;
    map.locate({ watch:true, enableHighAccuracy:true });
  } else {
    map.stopLocate();
    directionCone.setLatLngs([]);
  }
});


/* ============================================================
   ROTATION MODE
============================================================ */
let rotateMode = false;
const rotateBtn = document.getElementById("rotate-toggle");
const compass = document.getElementById("compass-indicator");

function applyRotation(h) {
  if (!rotateMode) return;
  mapPane.style.transform = `rotate(${h}deg)`;
  compass.style.transform = `rotate(${-h}deg)`;
}

rotateBtn.addEventListener("click", () => {
  rotateMode = !rotateMode;
  rotateBtn.classList.toggle("rotate-on", rotateMode);
  compass.classList.toggle("hidden", !rotateMode);

  if (!rotateMode) mapPane.style.transform = "rotate(0deg)";
});

/* continue rotation smoothing */
setInterval(()=>{
  if (rotateMode && smoothHeading!=null) applyRotation(smoothHeading);
},80);

</script>
</body>
</html>
