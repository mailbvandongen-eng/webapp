<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Detectorkaart V2 – bvd 8.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="madelinus.png" />

  <!-- Cache uit -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Light-only hints -->
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ============================================================
   HARD LIGHT MODE
   ============================================================ */
* {
  color-scheme: light !important;
  forced-color-adjust: none !important;
}
html, body {
  margin: 0; padding: 0; height: 100%;
  background: #fff !important;
  font-family: system-ui, sans-serif;
  color: #111827;
}
#app { height: 100vh; width: 100vw; position: relative; }
#map { height: 100%; width: 100%; }

/* ============================================================
   GENERIC CONTROL BUTTON
   ============================================================ */
.control-button {
  width: 38px; height: 38px;
  border-radius: 10px;
  background: #fff;
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 9999;
}
.control-button:hover { background: #f3f4f6; }
.control-button .icon {
  width: 22px; height: 22px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 22px 22px;
}

/* ============================================================
   GPS KNOP – linksboven
   ============================================================ */
#gps-toggle {
  position: absolute;
  left: 10px; top: 10px;
}
#gps-toggle .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%236b7280' ...");
}
#gps-toggle.gps-on .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%232563EB' ...");
}
#gps-toggle.gps-on {
  box-shadow: 0 0 6px rgba(37,99,235,0.55);
}

/* ============================================================
   GPS BEACON + HEADING CONE (NIEUW in 8.5)
   ============================================================ */

/* Witte ring */
.gps-ring {
  width: 18px; height: 18px;
  border: 3px solid white;
  border-radius: 50%;
  background: #1a73e8;
  box-shadow: 0 0 6px rgba(0,0,0,0.35);
}

/* Heading-cone */
.heading-cone {
  width: 0;
  height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 32px solid rgba(26,115,232,0.45);
  margin-left: -14px;
  margin-top: -6px;
  filter: blur(0.5px);
  transform-origin: center bottom;
}

/* ============================================================
   BUILD LABEL – linksonder
   ============================================================ */
.build-label {
  position: absolute;
  left: 10px;
  bottom: 80px;
  font-size: 10px;
  color: #6b7280;
  background: rgba(255,255,255,0.9);
  padding: 3px 8px;
  border-radius: 999px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  z-index: 9999;
}

/* Popup styling – strak */
.popup-mon {
  font-size: 12px;
  line-height: 1.4;
  max-width: 200px;
}
</style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <!-- GPS knop -->
  <button id="gps-toggle" class="control-button gps-off" type="button">
    <div class="icon"></div>
  </button>

  <!-- Build label -->
  <div class="build-label">bvd 8.5</div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
console.log("Detectorkaart V2 – bvd 8.5 geladen");

/* ============================================================
   KAART INIT
   ============================================================ */
const map = L.map("map", { zoomControl: false })
  .setView([52.07, 4.35], 12);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19 }
).addTo(map);

/* ============================================================
   AMK MONUMENTEN — officiële kleuren (jouw 8.3 palette)
   ============================================================ */

const amkLayer = L.layerGroup();

function amkColor(waarde) {
  if (!waarde) return "#ddd";
  const v = waarde.trim();

  switch (v) {
    case "Terrein van archeologische waarde":
      return "#c4b5fd"; // licht
    case "Terrein van hoge archeologische waarde":
      return "#8b5cf6"; // medium licht
    case "Terrein van zeer hoge archeologische waarde":
      return "#6d28d9"; // medium
    case "Terrein van zeer hoge archeologische waarde, beschermd":
      return "#4c1d95"; // donker
    default:
      return "#ddd";
  }
}

fetch("data/amk_monumenten.topojson")
  .then(r => r.json())
  .then(topo => {
    const key = Object.keys(topo.objects)[0];
    const geo = topojson.feature(topo, topo.objects[key]);

    const layer = L.geoJSON(geo, {
      style: f => {
        const w = f.properties?.WAARDE;
        const c = amkColor(w);
        return {
          color: c,
          fillColor: c,
          fillOpacity: 0.35,
          weight: 1
        };
      },

      onEachFeature: (f, poly) => {
        const w = f.properties?.WAARDE ?? "";
        const nr = f.properties?.MONUMENTNR ?? "";

        poly.bindPopup(`
          <div class="popup-mon">
            <strong>${w}</strong><br>
            ${nr ? "Monumentnr: " + nr : ""}
          </div>
        `);
      }
    });

    amkLayer.addLayer(layer);
  });

/* ============================================================
   GPS + HEADING MODE (8.5)
   ============================================================ */

let gpsActive = false;
let gpsMarker = null;      // de witte ring
let headingMarker = null;  // de cone
let accuracyCircle = null; // de blauwe precisiecirkel
let heading = 0;

/* -------- HEADING LISTENER -------- */
if (window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientationabsolute", e => {
    if (e.alpha != null) heading = e.alpha;
  });

  window.addEventListener("deviceorientation", e => {
    if (e.alpha != null) heading = e.alpha;
  });
}

/* -------- GPS BUTTON -------- */
const gpsBtn = document.getElementById("gps-toggle");

gpsBtn.addEventListener("click", () => {
  gpsActive = !gpsActive;
  gpsBtn.classList.toggle("gps-on", gpsActive);

  if (gpsActive) {
    map.locate({
      watch: true,
      enableHighAccuracy: true
    });

    // jump-to-location bij activatie
    if (lastLatLng) map.setView(lastLatLng, 17);

  } else {
    map.stopLocate();
  }
});

let lastLatLng = null;

/* -------- LOCATION FOUND -------- */
map.on("locationfound", e => {
  lastLatLng = e.latlng;

  /* PRECISION CIRCLE */
  if (!accuracyCircle) {
    accuracyCircle = L.circle(e.latlng, {
      radius: e.accuracy,
      color: "#1a73e8",
      fillColor: "#1a73e8",
      fillOpacity: 0.1,
      weight: 1
    }).addTo(map);
  } else {
    accuracyCircle.setLatLng(e.latlng);
    accuracyCircle.setRadius(e.accuracy);
  }

  /* WHITE RING (BEACON) */
  if (!gpsMarker) {
    gpsMarker = L.marker(e.latlng, {
      icon: L.divIcon({
        className: "",
        html: `<div class="gps-ring"></div>`,
        iconSize: [18,18],
        iconAnchor: [9,9]
      })
    }).addTo(map);
  } else {
    gpsMarker.setLatLng(e.latlng);
  }

  /* HEADING CONE */
  if (!headingMarker) {
    headingMarker = L.marker(e.latlng, {
      icon: L.divIcon({
        className: "",
        html: `<div class="heading-cone"></div>`,
        iconSize: [0,0],
        iconAnchor: [0,24]
      })
    }).addTo(map);
  }

  // rotate cone
  headingMarker.getElement().children[0].style.transform =
    `rotate(${heading}deg)`;

  // move cone
  headingMarker.setLatLng(e.latlng);
});

/* -------- LOCATION ERROR -------- */
map.on("locationerror", e => {
  alert("GPS fout: " + e.message);
});
/* ============================================================
   ARCHIS-PUNTEN — subtiele paarse dots, meeschalend
   ============================================================ */
const puntenLayer = L.layerGroup();

function makeArchisIcon(zoom) {
  const size = Math.max(10, Math.min(20, zoom * 1.15));
  return L.divIcon({
    html: `<div style="
      font-size:${size}px;
      color:#7c3aed;
      line-height:1;
    ">●</div>`,
    className: "",
    iconSize: [size,size],
    iconAnchor: [size/2, size/2]
  });
}

fetch("data/punten_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (_, latlng) =>
        L.marker(latlng, { icon: makeArchisIcon(map.getZoom()) })
    });

    puntenLayer.addLayer(layer);

    map.on("zoomend", () => {
      layer.eachLayer(m => m.setIcon(makeArchisIcon(map.getZoom())));
    });
  });

/* ============================================================
   TOESTEMMINGEN — groene ★ meeschalend
   ============================================================ */
const toestLayer = L.layerGroup();

function makeToestIcon(zoom) {
  const size = Math.max(12, Math.min(22, zoom * 1.2));
  return L.divIcon({
    html: `<div style="font-size:${size}px; color:#22c55e;">★</div>`,
    className: "",
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });
}

fetch("data/toestemmingen_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (_, latlng) =>
        L.marker(latlng, { icon: makeToestIcon(map.getZoom()) })
    });

    toestLayer.addLayer(layer);

    map.on("zoomend", () => {
      layer.eachLayer(m => m.setIcon(makeToestIcon(map.getZoom())));
    });
  });

/* ============================================================
   CASTELLA (punten) — blauwe dots
   ============================================================ */
const romPtsLayer = L.layerGroup();

function makeCastellaIcon(zoom) {
  const size = Math.max(10, Math.min(20, zoom * 1.1));
  return L.divIcon({
    html: `<div style="
      font-size:${size}px;
      color:#2b6cb0;
      line-height:1;
    ">●</div>`,
    className: "",
    iconSize: [size,size],
    iconAnchor: [size/2, size/2]
  });
}

fetch("data/rom_def_points.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (_, latlng) =>
        L.marker(latlng, { icon: makeCastellaIcon(map.getZoom()) })
    });

    romPtsLayer.addLayer(layer);

    map.on("zoomend", () => {
      layer.eachLayer(m => m.setIcon(makeCastellaIcon(map.getZoom())));
    });
  });

/* ============================================================
   CASTELLA (lijnen)
   ============================================================ */
const romLineLayer = L.layerGroup();

fetch("data/rom_def_lines.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      style: {
        color: "#2b6cb0",
        weight: 2,
        opacity: 0.7,
        lineJoin: "round",
        lineCap: "round"
      }
    });

    romLineLayer.addLayer(layer);
  });

/* ============================================================
   MONUMENTEN (eigen) — labels bij zoom >= 14
   ============================================================ */
const customMonLayer = L.layerGroup();
let monLabels = [];

fetch("data/monumenten_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      style: {
        color: "#9333ea",
        fillColor: "#c4b5fd",
        fillOpacity: 0.35,
        weight: 1.2
      },

      onEachFeature: (f, poly) => {
        const name =
          f.properties.name ||
          f.properties.Name ||
          f.properties.Naam ||
          null;

        const desc =
          f.properties.description ||
          f.properties.Description ||
          f.properties.Omschrijving ||
          null;

        if (desc) {
          poly.bindPopup(`
            <div class="popup-mon">
              <strong>${name ?? "Monument"}</strong><br>
              ${desc}
            </div>
          `);
        }

        if (name) {
          const c = poly.getBounds().getCenter();
          const lbl = L.marker(c, {
            icon: L.divIcon({
              className: "mon-label",
              html: name,
              iconSize: null
            }),
            interactive: false
          });
          monLabels.push(lbl);
        }
      }
    });

    customMonLayer.addLayer(layer);

    function updateMonLabels() {
      if (map.getZoom() >= 14) {
        monLabels.forEach(l => l.addTo(customMonLayer));
      } else {
        monLabels.forEach(l => customMonLayer.removeLayer(l));
      }
    }

    map.on("zoomend", updateMonLabels);
    updateMonLabels();
  });

/* ============================================================
   LAATSTE STAP: ALLE LAGEN OP DE KAART — ZONDER LAGENSELECTOR
   ============================================================ */

amkLayer.addTo(map);
customMonLayer.addTo(map);
puntenLayer.addTo(map);
toestLayer.addTo(map);
romPtsLayer.addTo(map);
romLineLayer.addTo(map);

/* ============================================================
   EINDE SCRIPT — BVD 8.5
   ============================================================ */
</script>
</body>
</html>
  
