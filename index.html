<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Detectorkaart V2 – Build 7.0</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Cache uit -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      #app {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        font-family: system-ui, sans-serif;
      }

      .app-header {
        padding: 8px 12px;
        background: #111827;
        color: #e5e7eb;
        border-bottom: 1px solid #1f2937;
      }

      #map {
        flex: 1;
        width: 100%;
      }

      .gps-toggle {
        position: absolute;
        right: 12px;
        top: 60px;
        z-index: 1000;
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #f9fafb;
      }

      .gps-toggle.gps-off { background: #7f1d1d; }
      .gps-toggle.gps-on  { background: #14532d; }

      .gps-marker {
        stroke-width: 3px;
        stroke: #000b7a !important;
        fill: #0033ff !important;
      }

      .leaflet-top.leaflet-right {
        margin-top: 120px;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <header class="app-header">
        <div class="app-title">Detectorkaart V2</div>
        <div class="app-subtitle">Build 7.0 – AMK + Mijn monumenten + Geomorf + AHN + GPS</div>
      </header>

      <div id="map"></div>

      <button id="gps-toggle" class="gps-toggle gps-off" type="button">
        <span class="gps-label">GPS uit</span>
      </button>
    </div>

    <!-- JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
      console.log("Detectorkaart V2 – Build 7.0 geladen");

      document.addEventListener("DOMContentLoaded", () => {

        const map = L.map("map").setView([52.07, 4.35], 12);

        /* ---------------------------------------
           Basemaps
        ---------------------------------------- */
        const osm = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          { maxZoom: 19 }
        ).addTo(map);

        const googleHybrid = L.tileLayer(
          "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
          { maxZoom: 20 }
        );

        /* ---------------------------------------
           PDOK lagen
        ---------------------------------------- */
        const ahnWms = L.tileLayer.wms(
          "https://service.pdok.nl/rws/ahn/wms/v1_0?",
          {
            layers: "dtm_05m",
            format: "image/png",
            transparent: true,
          }
        );

        const geomorf = L.tileLayer.wms(
          "https://service.pdok.nl/bzk/bro-geomorfologischekaart/wms/v2_0?",
          {
            layers: "geomorphological_area",
            format: "image/png",
            transparent: true,
          }
        );

        /* ---------------------------------------
           AMK Monumenten (TopoJSON – landelijk)
        ---------------------------------------- */
        const amkLayer = L.layerGroup();

        fetch("data/amk_monumenten.topojson")
          .then(r => r.json())
          .then(topo => {
            const name = Object.keys(topo.objects)[0];
            const geo = topojson.feature(topo, topo.objects[name]);

            const layer = L.geoJSON(geo, {
              style: { color: "#ff7300", weight: 1, fillOpacity: 0.25 },
              onEachFeature: (f, l) => {
                const p = f.properties || {};
                const nr = p.MONUMENTNR ?? "onbekend";
                const waarde = p.WAARDE ?? "geen info";

                l.bindPopup(`<b>Monument ${nr}</b><br>${waarde}`);
              }
            });

            amkLayer.addLayer(layer);
            console.log("AMK Monumenten geladen:", name);
          })
          .catch(err => console.error("AMK monumenten fout:", err));

        /* ---------------------------------------
           MIJN MONUMENTEN (monumenten_custom.geojson)
        ---------------------------------------- */
        const mijnMonumentenLayer = L.layerGroup();

        fetch("data/monumenten_custom.geojson")
          .then(r => r.json())
          .then(geojson => {
            const layer = L.geoJSON(geojson, {
              style: {
                color: "#5a1b78",
                fillColor: "#9b4db7",
                fillOpacity: 0.35,
                weight: 1.2
              },
              onEachFeature: (f, l) => {
                const p = f.properties || {};
                const naam = p.Naam || "Onbekend monument";
                const oms  = p.Omschrijving || "(geen omschrijving)";

                l.bindPopup(`<b>${naam}</b><br>${oms}`);
              }
            });

            mijnMonumentenLayer.addLayer(layer);
            console.log("Mijn monumenten (custom) geladen");
          })
          .catch(err => console.error("Mijn monumenten fout:", err));

        /* ---------------------------------------
           Layer Control
        ---------------------------------------- */
        const baseLayers = {
          "OpenStreetMap": osm,
          "Google Satellite Hybrid": googleHybrid,
        };

        const overlays = {
          "AHN DTM 0.5m": ahnWms,
          "Geomorfologie (BRO)": geomorf,
          "Monumenten (AMK)": amkLayer,
          "Mijn monumenten (custom)": mijnMonumentenLayer
        };

        L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

        /* ---------------------------------------
           GPS Tracking
        ---------------------------------------- */
        let gpsMarker = null;
        let gpsAccuracy = null;
        let tracking = false;

        function updateGps(latlng, acc) {
          if (!gpsMarker) {
            gpsMarker = L.circleMarker(latlng, {
              radius: 7,
              weight: 3,
              className: "gps-marker"
            }).addTo(map);
          } else {
            gpsMarker.setLatLng(latlng);
          }

          if (!gpsAccuracy) {
            gpsAccuracy = L.circle(latlng, {
              radius: acc,
              fillOpacity: 0.15,
              color: "#1d4ed8"
            }).addTo(map);
          } else {
            gpsAccuracy.setLatLng(latlng);
            gpsAccuracy.setRadius(acc);
          }
        }

        map.on("locationfound", e => {
          if (!tracking) return;
          updateGps(e.latlng, e.accuracy);
          map.setView(e.latlng, 17);
        });

        map.on("locationerror", e => alert("GPS fout: " + e.message));

        const gpsBtn   = document.getElementById("gps-toggle");
        const gpsLabel = gpsBtn.querySelector(".gps-label");

        gpsBtn.addEventListener("click", () => {
          tracking = !tracking;

          gpsBtn.classList.toggle("gps-on", tracking);
          gpsBtn.classList.toggle("gps-off", !tracking);
          gpsLabel.textContent = tracking ? "GPS aan" : "GPS uit";

          if (tracking) {
            map.locate({ watch: true, enableHighAccuracy: true });
          } else {
            map.stopLocate();
            if (gpsMarker)   map.removeLayer(gpsMarker);
            if (gpsAccuracy) map.removeLayer(gpsAccuracy);
            gpsMarker   = null;
            gpsAccuracy = null;
          }
        });

      });
    </script>
  </body>
</html>
