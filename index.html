<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Detectorkaart V2 – Build 7.3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="madelinus.png" />

    <!-- Cache uit -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
  :root {
    color-scheme: only light !important;
    forced-color-adjust: none !important;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #ffffff !important;
    font-family: system-ui, sans-serif;
  }

  #app {
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
  }

  /* HEADER */
  .app-header {
    padding: 8px 12px;
    background: #111827;
    color: #e5e7eb;
    border-bottom: 1px solid #1f2937;
  }
  .app-title { font-size: 16px; font-weight: 600; }
  .app-subtitle { font-size: 11px; color: #9ca3af; }

  #map {
    flex: 1;
    width: 100%;
  }

  /* --------------------------------------
     MODERNE KNOP-STIJL (Zoom + GPS)
     -------------------------------------- */

  /* container van zoom linksboven iets netter */
  .leaflet-control-zoom {
    margin-top: 10px !important;
    margin-left: 10px !important;
  }

  /* losse vierkante knoppen, geen zandloper */
  .leaflet-control-zoom a {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    border-radius: 10px !important;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    color: #111827 !important;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    display: block;
  }

  .leaflet-control-zoom-in {
    margin-bottom: 6px;   /* ruimte tussen + en − */
  }

  .leaflet-control-zoom a:hover {
    background: #f3f4f6 !important;
  }

  /* GPS-knop: zelfde stijl als zoom, maar eigen positie */
  #gps-toggle {
    position: absolute;
    left: 10px;
    top: 100px;            /* netjes onder de − knop */
    z-index: 1000;
    width: 38px;
    height: 38px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  #gps-toggle:hover {
    background: #f3f4f6;
  }

  /* grijs iOS-achtige locatie-cirkel in de knop */
  #gps-toggle .gps-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid #6b7280;   /* mooi grijs */
    box-sizing: border-box;
  }

  /* als GPS aan staat: subtiele highlight van de knop */
  #gps-toggle.gps-on {
    border-color: #2563eb;
    box-shadow: 0 0 6px rgba(37,99,235,0.5);
  }

  /* --------------------------------------
     LAYER CONTROL RECHTSBOVEN
     -------------------------------------- */

  /* positie container rechtsboven gelijk aan zoom-links */
  .leaflet-top.leaflet-right {
    margin-top: 10px !important;   /* zelfde top als zoom */
    margin-right: 10px !important;
  }

  .leaflet-control-layers {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
  }

  /* de toggle zelf als nette knop, zelfde formaat */
  .leaflet-control-layers-toggle {
    width: 38px !important;
    height: 38px !important;
    background-color: #ffffff !important;
    background-position: center center !important;
    background-repeat: no-repeat !important;
    background-size: 22px 22px !important;
    border-radius: 10px !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25) !important;
  }

  .leaflet-control-layers-toggle:hover {
    background-color: #f3f4f6 !important;
  }
</style>

  </head>

  <body>
    <div id="app">
      <header class="app-header">
        <div class="app-title">Detectorkaart V2</div>
        <div class="app-subtitle">
          Build 7.3 – AMK + eigen monumenten + vondsten + geomorf + AHN + GPS
        </div>
      </header>

      <div id="map"></div>

      <!-- GPS knop -->
      <button id="gps-toggle" class="gps-toggle gps-off" type="button">
        <div class="gps-icon"></div>
      </button>
    </div>

    <!-- JS libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
      console.log("Detectorkaart V2 – Build 7.3 geladen");

      /* --------------------------------------
         KAART INIT
      -------------------------------------- */
      const map = L.map("map").setView([52.07, 4.35], 12);

      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom: 19 }
      ).addTo(map);

      const googleHybrid = L.tileLayer(
        "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
        { maxZoom: 20 }
      );

      /* --------------------------------------
         PDOK LAGEN
      -------------------------------------- */
      const ahnWms = L.tileLayer.wms(
        "https://service.pdok.nl/rws/ahn/wms/v1_0?",
        { layers: "dtm_05m", format: "image/png", transparent: true }
      );

      const geomorf = L.tileLayer.wms(
        "https://service.pdok.nl/bzk/bro-geomorfologischekaart/wms/v2_0?",
        { layers: "geomorphological_area", format: "image/png", transparent: true }
      );

      /* --------------------------------------
         AMK MONUMENTEN
      -------------------------------------- */
      const amkLayer = L.layerGroup();
      fetch("data/amk_monumenten.topojson")
        .then(r => r.json())
        .then(topo => {
          const name = Object.keys(topo.objects)[0];
          const geo = topojson.feature(topo, topo.objects[name]);
          const layer = L.geoJSON(geo, {
            style: { color: "#a855f7", weight: 1, fillOpacity: 0.25 },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(`<b>${p.Naam ?? p.MONUMENTNR ?? "Monument"}</b>`);
            }
          });
          amkLayer.addLayer(layer);
        });

      /* --------------------------------------
         EIGEN MONUMENTEN
      -------------------------------------- */
      const customMonLayer = L.layerGroup();
      fetch("data/monumenten_custom.geojson")
        .then(r => r.json())
        .then(geo => {
          const layer = L.geoJSON(geo, {
            style: {
              color: "#9333ea",
              fillColor: "#c4b5fd",
              fillOpacity: 0.35,
              weight: 1.2
            },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(`<b>${p.Naam}</b><br>${p.Omschrijving ?? ""}`);
            }
          });
          customMonLayer.addLayer(layer);
        });

      /* --------------------------------------
         VONDSTEN
      -------------------------------------- */
      const puntenLayer = L.layerGroup();
      fetch("data/punten_custom.geojson")
        .then(r => r.json())
        .then(geo => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 5, color: "#7c3aed",
                fillColor: "#a78bfa", fillOpacity: 0.9
              }),
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(`<b>${p.Naam}</b><br>${p.Omschrijving ?? ""}`);
            }
          });
          puntenLayer.addLayer(layer);
        });

      /* --------------------------------------
         TOESTEMMINGEN (✔)
      -------------------------------------- */
      const toestLayer = L.layerGroup();
      function makeToestIcon(zoom) {
        const size = Math.max(12, Math.min(22, zoom * 1.2));
        return L.divIcon({
          html: `<div style="font-size:${size}px;
                 color:#22c55e;font-weight:bold;
                 text-shadow:0 0 2px black;">✔</div>`,
          iconSize: [size, size], iconAnchor: [size/2, size/2]
        });
      }
      fetch("data/toestemmingen_custom.geojson")
        .then(r => r.json())
        .then(geo => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.marker(latlng, { icon: makeToestIcon(map.getZoom()) }),
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(`<b>Toestemming</b><br>${p.Naam}`);
            }
          });
          toestLayer.addLayer(layer);
          map.on("zoomend", () =>
            layer.eachLayer(m =>
              m.setIcon(makeToestIcon(map.getZoom()))
            )
          );
        });

      /* --------------------------------------
         ROM. PUNTEN + LINIEN
      -------------------------------------- */
      const romPtsLayer = L.layerGroup();
      fetch("data/rom_def_points.geojson")
        .then(r => r.json())
        .then(geo => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 6, color: "#001f54",
                fillColor: "#003b99", fillOpacity: 0.9
              }),
          });
          romPtsLayer.addLayer(layer);
        });

      const romLineLayer = L.layerGroup();
      fetch("data/rom_def_lines.geojson")
        .then(r => r.json())
        .then(geo => {
          const layer = L.geoJSON(geo, {
            style: { color: "#001b44", weight: 3, opacity: 0.9 }
          });
          romLineLayer.addLayer(layer);
        });

      /* --------------------------------------
         LAAGSELECTOR
      -------------------------------------- */
      const baseLayers = {
        "OpenStreetMap": osm,
        "Google Hybrid": googleHybrid
      };

      const overlays = {
        "AHN 0.5m": ahnWms,
        "Geomorfologie": geomorf,
        "AMK Monumenten": amkLayer,
        "Eigen monumenten": customMonLayer,
        "Vondsten": puntenLayer,
        "Toestemmingen": toestLayer,
        "Romeinse punten": romPtsLayer,
        "Romeinse lijnen": romLineLayer
      };

      L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

      /* --------------------------------------
         GPS (Optie B – iOS stijl)
      -------------------------------------- */
      let tracking = false;

      let gpsMarker = L.circleMarker([52.07, 4.35], {
        radius: 6,
        color: "#1a73e8",
        fillColor: "#1a73e8",
        fillOpacity: 1,
        weight: 2
      }).addTo(map);

      let gpsAccuracy = L.circle([52.07, 4.35], {
        radius: 0,
        color: "#1a73e8",
        fillOpacity: 0.15
      }).addTo(map);

      function updateGps(latlng, acc) {
        gpsMarker.setLatLng(latlng);
        gpsAccuracy.setLatLng(latlng);
        gpsAccuracy.setRadius(acc);
      }

      map.on("locationfound", (e) => {
        if (!tracking) return;
        updateGps(e.latlng, e.accuracy);
      });

      const gpsBtn = document.getElementById("gps-toggle");
      gpsBtn.addEventListener("click", () => {
        tracking = !tracking;
        gpsBtn.classList.toggle("gps-on", tracking);

        if (tracking) {
          map.locate({ watch: true, enableHighAccuracy: true });
        } else {
          map.stopLocate();
        }
      });
    </script>
  </body>
</html>
