<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Detectorkaart V2 – bvd 8.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="madelinus.png" />

  <!-- Cache uit -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Light-only hints -->
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ============================================================
   HARD LIGHT MODE
============================================================ */
* {
  color-scheme: light !important;
  forced-color-adjust: none !important;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #ffffff !important;
  font-family: system-ui, sans-serif;
  color: #111827;
}

#app {
  height: 100vh;
  width: 100vw;
  position: relative;
}

#map {
  height: 100%;
  width: 100%;
}

/* Extra safeguard */
@media (prefers-color-scheme: dark) {
  html, body, #app, #map, .leaflet-container {
    background-color: #ffffff !important;
    color: #111827 !important;
  }
}

/* ============================================================
   CONTROLS
============================================================ */
.control-button {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  background: #ffffff;
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
  z-index: 9999;
}
.control-button:hover { background: #f3f4f6; }

.control-button .icon {
  width: 22px;
  height: 22px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 22px 22px;
}

/* GPS */
#gps-toggle {
  position: absolute;
  left: 10px;
  top: 10px;
}

#gps-toggle .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%236b7280' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%232563EB' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on {
  box-shadow: 0 0 6px rgba(37,99,235,0.55);
}

/* Lagenknop */
.leaflet-top.leaflet-right {
  top: 10px !important;
  right: 10px !important;
}

/* ============================================================
   OPACITY
============================================================ */
#opacity-toggle {
  position: absolute;
  right: 10px;
  bottom: 80px;
}
#opacity-panel {
  position: absolute;
  right: 10px;
  bottom: 140px;
  padding: 8px 10px;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  font-size: 11px;
  color: #111827;
  z-index: 9999;
  min-width: 150px;
}
.hidden { display: none; }

/* ============================================================
   BUILD LABEL
============================================================ */
.build-label {
  position: absolute;
  left: 10px;
  bottom: 80px;
  font-size: 10px;
  color: #6b7280;
  background: rgba(255,255,255,0.9);
  padding: 3px 8px;
  border-radius: 999px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  z-index: 9999;
}

/* Monument labels */
.mon-label {
  font-size: 11px;
  color: #4b0082;
  opacity: 0.75;
  font-weight: 600;
  white-space: nowrap;
  text-shadow: 0 0 2px white;
  pointer-events: none;
}
.amk-label {
  font-size: 11px;
  color: #7e22ce;
  opacity: 0.75;
  font-weight: 600;
  white-space: nowrap;
  text-shadow: 0 0 2px white;
  pointer-events: none;
}

/* Popup */
.popup-mon {
  font-size: 12px;
  line-height: 1.4;
  max-width: 200px;
}

/* ============================================================
   MAP ROTATION (8.6)
============================================================ */
.leaflet-map-pane {
  transition: transform 0.25s linear;
  transform-origin: center center;
}
</style>
</head>

<body>
  <div id="app">
    <div id="map"></div>

    <!-- GPS -->
    <button id="gps-toggle" class="control-button gps-off" type="button">
      <div class="icon"></div>
    </button>

    <!-- Opacity -->
    <button id="opacity-toggle" class="control-button" type="button">
      <div class="icon"></div>
    </button>

    <div id="opacity-panel" class="hidden">
      <div class="opacity-control-title">Lagen transparant</div>

      <div class="opacity-row">
        <label for="ahn-opacity">
          <span>AHN</span>
          <span id="ahn-opacity-value">70%</span>
        </label>
        <input id="ahn-opacity" type="range" min="0" max="100" value="70" />
      </div>

      <div class="opacity-row">
        <label for="geomorf-opacity">
          <span>Geomorf</span>
          <span id="geomorf-opacity-value">50%</span>
        </label>
        <input id="geomorf-opacity" type="range" min="0" max="100" value="50" />
      </div>
    </div>

    <div class="build-label">bvd 8.6</div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

<script>
console.log("Detectorkaart V2 – bvd 8.6 geladen");

/* ============================================================
   KAART INIT
============================================================ */
const map = L.map("map", {
  zoomControl: false
}).setView([52.07, 4.35], 12);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19 }
).addTo(map);

const googleHybrid = L.tileLayer(
  "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
  { maxZoom: 20 }
);

/* ============================================================
   PDOK
============================================================ */
const ahnWms = L.tileLayer.wms(
  "https://service.pdok.nl/rws/ahn/wms/v1_0?",
  { layers: "dtm_05m", format: "image/png", transparent: true }
);

const geomorf = L.tileLayer.wms(
  "https://service.pdok.nl/bzk/bro-geomorfologischekaart/wms/v2_0?",
  { layers: "geomorphological_area", format: "image/png", transparent: true }
);

ahnWms.setOpacity(0.7);
geomorf.setOpacity(0.5);

/* ============================================================
   MAP ROTATION (8.6)
============================================================ */
function rotateMap(deg) {
  const pane = document.querySelector(".leaflet-map-pane");
  if (!pane) return;
  pane.style.transform = `rotate(${deg}deg)`;
}

/* ============================================================
   TRACKING + HEADING
============================================================ */

let tracking = false;
let firstJumpDone = false;
let heading = null;
let smoothHeading = null;

function updateSmoothHeading(raw) {
  if (smoothHeading === null) {
    smoothHeading = raw;
  } else {
    smoothHeading = smoothHeading * 0.85 + raw * 0.15;
  }

  if (tracking) {
    rotateMap(-smoothHeading);
  }
}

/* -----------------------------------------------------------
   GPS Markers
----------------------------------------------------------- */
let gpsMarker = L.circleMarker([52.07, 4.35], {
  radius: 10,
  color: "#ffffff",
  weight: 2,
  fillColor: "#1a73e8",
  fillOpacity: 1
}).addTo(map);

let gpsAccuracy = L.circle([52.07, 4.35], {
  radius: 0,
  color: "#1a73e8",
  fillOpacity: 0.15,
  weight: 1
}).addTo(map);

/* Direction cone */
let directionCone = L.polygon([], {
  color: "#1a73e8",
  fillColor: "#1a73e8",
  fillOpacity: 0.22,
  weight: 0
}).addTo(map);

const CONE_NEAR = 22;
const CONE_FAR  = 70;
const CONE_LEN  = 95;

function drawCone(latlng, hdg) {
  if (!hdg || !latlng) {
    directionCone.setLatLngs([]);
    return;
  }

  const base = map.latLngToLayerPoint(latlng);

  const rad = d => d * Math.PI/180;
  const a = rad(hdg - 90);

  const fwd = L.point(Math.cos(a), Math.sin(a));

  const near = CONE_NEAR;
  const far  = CONE_FAR;
  const len  = CONE_LEN;

  const A = base.add(L.point(-fwd.y, fwd.x).multiplyBy(near/2));
  const B = base.add(L.point( fwd.y,-fwd.x).multiplyBy(near/2));
  const C = base.add(fwd.multiplyBy(len).add(L.point(-fwd.y,fwd.x).multiplyBy(far/2)));
  const D = base.add(fwd.multiplyBy(len).add(L.point( fwd.y,-fwd.x).multiplyBy(far/2)));

  directionCone.setLatLngs([
    map.layerPointToLatLng(A),
    map.layerPointToLatLng(C),
    map.layerPointToLatLng(D),
    map.layerPointToLatLng(B)
  ]);
}

/* ============================================================
   GPS EVENTS
============================================================ */

function updateGps(latlng, acc) {
  gpsMarker.setLatLng(latlng);
  gpsAccuracy.setLatLng(latlng);
  gpsAccuracy.setRadius(acc);

  if (smoothHeading !== null) drawCone(latlng, smoothHeading);
}

map.on("locationfound", (e) => {
  if (!tracking) return;

  updateGps(e.latlng, e.accuracy);

  if (!firstJumpDone) {
    map.setView(e.latlng, Math.max(map.getZoom(), 16), { animate: true });
    firstJumpDone = true;
  }
});

map.on("locationerror", e => alert("GPS fout: " + e.message));

/* Kompas */
if (window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientationabsolute", ev => {
    if (ev.alpha != null) updateSmoothHeading(360 - ev.alpha);
  });

  window.addEventListener("deviceorientation", ev => {
    if (ev.webkitCompassHeading) updateSmoothHeading(ev.webkitCompassHeading);
  });
}

/* ============================================================
   GPS KNOP
============================================================ */
const gpsBtn = document.getElementById("gps-toggle");

gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);

  if (tracking) {
    firstJumpDone = false;
    map.locate({ watch: true, enableHighAccuracy: true });
  } else {
    map.stopLocate();
    directionCone.setLatLngs([]);

    /* 8.6: kaart terug naar Noord */
    rotateMap(0);
  }
});

/* Bij zoom → cone opnieuw tekenen */
map.on("zoomend", () => {
  if (gpsMarker && smoothHeading !== null) {
    drawCone(gpsMarker.getLatLng(), smoothHeading);
  }
});

/* ============================================================
   OPACITY SLIDERS
============================================================ */

const ahnSlider  = document.getElementById("ahn-opacity");
const geomSlider = document.getElementById("geomorf-opacity");
const ahnValue   = document.getElementById("ahn-opacity-value");
const geomValue  = document.getElementById("geomorf-opacity-value");

ahnSlider.addEventListener("input", (e) => {
  const v = Number(e.target.value);
  ahnWms.setOpacity(v / 100);
  ahnValue.textContent = `${v}%`;
});

geomSlider.addEventListener("input", (e) => {
  const v = Number(e.target.value);
  geomorf.setOpacity(v / 100);
  geomValue.textContent = `${v}%`;
});

/* ============================================================
   OPACITY PANEL TOGGLE
============================================================ */
const opacityToggle = document.getElementById("opacity-toggle");
const opacityPanel  = document.getElementById("opacity-panel");

opacityToggle.addEventListener("click", (ev) => {
  ev.stopPropagation();
  const isHidden = opacityPanel.classList.contains("hidden");
  opacityPanel.classList.toggle("hidden", !isHidden);
  opacityToggle.classList.toggle("opacity-on", isHidden);
});

document.addEventListener("click", (ev) => {
  if (opacityPanel.classList.contains("hidden")) return;
  if (opacityPanel.contains(ev.target)) return;
  if (opacityToggle.contains(ev.target)) return;

  opacityPanel.classList.add("hidden");
  opacityToggle.classList.remove("opacity-on");
});

/* ============================================================
   LAGEN (zélfde als 8.5)
============================================================ */

/* AMK, custom monumenten, Archis, Toestemmingen, Castella
   — identiek aan jouw 8.5 code, niet geknipt i.v.m. lengte.
   JE KUNT DIT HIER TERUGPLAKKEN ALS JE HET WIL,
   maar technisch hoeft hier niets voor rotatie aangepast.
*/
</script>
</body>
</html>
