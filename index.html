<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Detectorkaart V2 – Build 7.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Cache uit voor index -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

   <style>
    :root {
      color-scheme: only light !important;
      forced-color-adjust: none !important;
    }
    html, body {
      background: #ffffff !important;
    }
  </style>
    
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      #app {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        font-family: system-ui, sans-serif;
      }

      .app-header {
        padding: 8px 12px;
        background: #111827;
        color: #e5e7eb;
        border-bottom: 1px solid #1f2937;
      }

      .app-title {
        font-size: 16px;
        font-weight: 600;
      }

      .app-subtitle {
        font-size: 11px;
        color: #9ca3af;
      }

      #map {
        flex: 1;
        width: 100%;
      }

      .gps-toggle {
        position: absolute;
        right: 12px;
        top: 60px;
        z-index: 1000;
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #f9fafb;
      }

      .gps-toggle.gps-off {
        background: #7f1d1d;
      }

      .gps-toggle.gps-on {
        background: #14532d;
      }

      .gps-marker {
        stroke-width: 3px;
        stroke: #000b7a !important;
        fill: #0033ff !important;
      }

      /* Pulserende GPS-marker */
.pulse {
  width: 14px;
  height: 14px;
  background: #0033ff;
  border: 3px solid #000b7a;
  border-radius: 50%;
  position: relative;
  box-sizing: content-box;
}

.pulse::after {
  content: "";
  position: absolute;
  width: 14px;
  height: 14px;
  left: -3px;
  top: -3px;
  border-radius: 50%;
  background: rgba(0, 51, 255, 0.35);
  animation: pulseAnim 2s infinite ease-out;
}

@keyframes pulseAnim {
  0% {
    transform: scale(1);
    opacity: 0.7;
  }
  100% {
    transform: scale(2.4);
    opacity: 0;
  }
}

      .leaflet-top.leaflet-right {
        margin-top: 120px;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <header class="app-header">
        <div class="app-title">Detectorkaart V2</div>
        <div class="app-subtitle">
          Build 7.1 – AMK + mijn monumenten + vondsten + geomorf + AHN + GPS
        </div>
      </header>

      <div id="map"></div>

      <button id="gps-toggle" class="gps-toggle gps-off" type="button">
        <span class="gps-label">GPS uit</span>
      </button>
    </div>

    <!-- JS libs -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
      console.log("Detectorkaart V2 – Build 7.1 geladen");

      // ================================
      // Kaart init
      // ================================
      const map = L.map("map").setView([52.07, 4.35], 12);

      // Basemaps
      const osm = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom: 19 }
      ).addTo(map);

      const googleHybrid = L.tileLayer(
        "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
        { maxZoom: 20 }
      );

      // ================================
      // PDOK lagen
      // ================================
      const ahnWms = L.tileLayer.wms(
        "https://service.pdok.nl/rws/ahn/wms/v1_0?",
        {
          layers: "dtm_05m",
          format: "image/png",
          transparent: true,
        }
      );

      const geomorf = L.tileLayer.wms(
        "https://service.pdok.nl/bzk/bro-geomorfologischekaart/wms/v2_0?",
        {
          layers: "geomorphological_area",
          format: "image/png",
          transparent: true,
        }
      );

      // ================================
      // AMK – landelijke monumenten (TopoJSON)
      // ================================
      const amkLayer = L.layerGroup();

      fetch("data/amk_monumenten.topojson")
        .then((r) => r.json())
        .then((topo) => {
          const name = Object.keys(topo.objects)[0];
          const geo = topojson.feature(topo, topo.objects[name]);

          const layer = L.geoJSON(geo, {
            style: { color: "#a855f7", weight: 1, fillOpacity: 0.25 },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              const naam = p.Naam ?? p.MONUMENTNR ?? "Monument";
              const oms = p.Omschrijving ?? p.WAARDE ?? "";
              l.bindPopup(`<b>${naam}</b><br>${oms}`);
            },
          });

          amkLayer.addLayer(layer);
          console.log("AMK monumenten geladen:", name);
        })
        .catch((err) => console.error("AMK monumenten fout:", err));

      // ================================
      // Eigen monumenten (monumenten_custom.geojson)
      // ================================
      const customMonLayer = L.layerGroup();

      fetch("data/monumenten_custom.geojson")
        .then((r) => r.json())
        .then((geo) => {
          const layer = L.geoJSON(geo, {
            style: {
              color: "#9333ea",
              fillColor: "#c4b5fd",
              fillOpacity: 0.35,
              weight: 1.2,
            },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              const naam = p.Naam || "Monument";
              const oms = p.Omschrijving || "(geen omschrijving)";
              l.bindPopup(`<b>${naam}</b><br>${oms}`);
            },
          });

          customMonLayer.addLayer(layer);
          console.log("Eigen monumenten geladen");
        })
        .catch((err) => console.error("Eigen monumenten fout:", err));

      // ================================
      // Oppida (oppida.geojson)
      // ================================
      const oppidaLayer = L.layerGroup();

      fetch("data/oppida.geojson")
        .then((r) => r.json())
        .then((geo) => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 7,
                color: "#ff0000",
                fillColor: "#ff0000",
                fillOpacity: 0.9,
              }),
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(`<b>Oppidum</b><br>${p.Naam ?? ""}`);
            },
          });
          oppidaLayer.addLayer(layer);
          console.log("Oppida geladen");
        })
        .catch((err) => console.error("Oppida fout:", err));

      // ================================
      // Vondsten – punten_custom.geojson
      // ================================
      const puntenLayer = L.layerGroup();

      fetch("data/punten_custom.geojson")
        .then((r) => r.json())
        .then((geo) => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 5,
                color: "#7c3aed",
                fillColor: "#a78bfa",
                fillOpacity: 0.9,
              }),
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(
                `<b>${p.Naam ?? "Vondst"}</b><br>${p.Omschrijving ?? ""}`
              );
            },
          });
          puntenLayer.addLayer(layer);
          console.log("Vondsten (punten_custom) geladen");
        })
        .catch((err) => console.error("punten_custom fout:", err));

     // ----------------------------------
// Toestemmingen – ✔ icoontje (helder groen, zoom-aware, subtiel)
// ----------------------------------
const toestLayer = L.layerGroup();

function makeToestemmingIcon(zoom) {
  const size = Math.max(12, Math.min(22, zoom * 1.2));  // schaal mee met zoom
  return L.divIcon({
    className: "toestemming-icon",
    html: `<div style="
      font-size:${size}px;
      line-height:1;
      color:#22c55e;        /* helder groen */
      text-shadow: 0 0 2px black; /* voor zichtbaarheid overal */
      font-weight:bold;
    ">✔</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });
}

fetch("data/toestemmingen_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (f, latlng) => {
        return L.marker(latlng, {
          icon: makeToestemmingIcon(map.getZoom())
        });
      },
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        l.bindPopup(
          `<b>Toestemming</b><br>${p.Naam ?? ""}<br>${p.Omschrijving ?? ""}`
        );
      }
    });

    toestLayer.addLayer(layer);

    // icoon mee laten schalen met zoom
    map.on("zoomend", () => {
      layer.eachLayer(marker => {
        if (marker.setIcon) {
          marker.setIcon(makeToestemmingIcon(map.getZoom()));
        }
      });
    });

    console.log("Toestemmingen geladen met ✔ helder groene icons");
  });



      // ================================
      // Romeinse verdedigingswerken – punten (rom_def_points.geojson)
      // donkerblauw
      // ================================
      const romPtsLayer = L.layerGroup();

      fetch("data/rom_def_points.geojson")
        .then((r) => r.json())
        .then((geo) => {
          const layer = L.geoJSON(geo, {
            pointToLayer: (f, latlng) =>
              L.circleMarker(latlng, {
                radius: 6,
                color: "#001f54",
                fillColor: "#003b99",
                fillOpacity: 0.9,
              }),
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(
                `<b>Romeins verdedigingspunt</b><br>${p.Naam ?? ""}`
              );
            },
          });
          romPtsLayer.addLayer(layer);
          console.log("Romeinse verdedigingspunten geladen");
        })
        .catch((err) => console.error("rom_def_points fout:", err));

      // ================================
      // Romeinse verdedigingswerken – lijnen (rom_def_lines.geojson)
      // donkerblauw
      // ================================
      const romLineLayer = L.layerGroup();

      fetch("data/rom_def_lines.geojson")
        .then((r) => r.json())
        .then((geo) => {
          const layer = L.geoJSON(geo, {
            style: {
              color: "#001b44",
              weight: 3,
              opacity: 0.9,
            },
            onEachFeature: (f, l) => {
              const p = f.properties || {};
              l.bindPopup(
                `<b>Romeinse linie</b><br>${p.Naam ?? ""}`
              );
            },
          });
          romLineLayer.addLayer(layer);
          console.log("Romeinse lijnen geladen");
        })
        .catch((err) => console.error("rom_def_lines fout:", err));

      // ================================
      // Layer control – Optie C
      // ================================
      const baseLayers = {
        OpenStreetMap: osm,
        "Google Hybrid": googleHybrid,
      };

      const overlays = {
        "AHN DTM 0.5m": ahnWms,
        Geomorfologie: geomorf,
        "AMK Monumenten": amkLayer,
        "Eigen monumenten": customMonLayer,
        "Vondsten (punten)": puntenLayer,
        Toestemmingen: toestLayer,
        Oppida: oppidaLayer,
        "Romeinse punten": romPtsLayer,
        "Romeinse lijnen": romLineLayer,
      };

      L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

   // ================================
// GPS – Pulsing Marker versie
// ================================
let tracking = false;

// Permanente pulserende GPS-marker
let gpsMarker = L.marker([52.07, 4.35], {
  icon: L.divIcon({
    className: "pulse",
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  })
}).addTo(map);

gpsMarker.setZIndexOffset(9999);

// Permanente accuracy-circle
let gpsAccuracy = L.circle([52.07, 4.35], {
  radius: 0,
  color: "#1d4ed8",
  fillOpacity: 0.15,
}).addTo(map);

// Updaten van locatie
function updateGps(latlng, acc) {
  gpsMarker.setLatLng(latlng);
  gpsAccuracy.setLatLng(latlng);
  gpsAccuracy.setRadius(acc);
}

// GPS event handlers
map.on("locationfound", (e) => {
  if (!tracking) return;
  updateGps(e.latlng, e.accuracy);
  map.setView(e.latlng, 17);
});

map.on("locationerror", (e) => alert("GPS fout: " + e.message));

// GPS-knop
const gpsBtn = document.getElementById("gps-toggle");
const gpsLabel = gpsBtn.querySelector(".gps-label");

gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);
  gpsBtn.classList.toggle("gps-off", !tracking);
  gpsLabel.textContent = tracking ? "GPS aan" : "GPS uit";

  if (tracking) {
    map.locate({ watch: true, enableHighAccuracy: true });
  } else {
    map.stopLocate();
    // Marker blijft staan — geen verwijdering meer!
    gpsAccuracy.setRadius(0); // eventueel laten staan als cirkel
  }
});


      map.on("locationerror", (e) => alert("GPS fout: " + e.message));

      const gpsBtn = document.getElementById("gps-toggle");
      const gpsLabel = gpsBtn.querySelector(".gps-label");

      gpsBtn.addEventListener("click", () => {
        tracking = !tracking;
        gpsBtn.classList.toggle("gps-on", tracking);
        gpsBtn.classList.toggle("gps-off", !tracking);
        gpsLabel.textContent = tracking ? "GPS aan" : "GPS uit";

        if (tracking) {
          map.locate({ watch: true, enableHighAccuracy: true });
       } else {
  map.stopLocate();
  // NIET verwijderen, marker houdt laatste locatie vast
  tracking = false;
}

      });
    </script>
  </body>
</html>
