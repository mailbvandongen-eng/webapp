<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Detectorkaart V2 – bvd 8.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" href="madelinus.png" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ============================================================
   HARD LIGHT MODE
============================================================ */
* {
  color-scheme: light !important;
  forced-color-adjust: none !important;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #ffffff !important;
  font-family: system-ui, sans-serif;
  color: #111827;
}

#app {
  height: 100vh;
  width: 100vw;
  position: relative;
}

#map {
  height: 100%;
  width: 100%;
}

/* ============================================================
   GENERIC CONTROL BUTTON
============================================================ */
.control-button {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  background: #ffffff;
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
  z-index: 9999;
}

.control-button:hover {
  background: #f3f4f6;
}

.control-button .icon {
  width: 22px;
  height: 22px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 22px 22px;
}

/* ============================================================
   GPS BUTTON
============================================================ */
#gps-toggle {
  position: absolute;
  left: 10px;
  top: 10px;
}

#gps-toggle .icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%236b7280' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on .icon {
  fill: #2563EB;
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%232563EB' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on {
  box-shadow: 0 0 6px rgba(37,99,235,0.55);
}
</style>
</head>

<body>
  <div id="app">
    <div id="map"></div>

    <button id="gps-toggle" class="control-button gps-off" type="button">
      <div class="icon"></div>
    </button>

    <div class="build-label">bvd 8.5</div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
console.log("LOCK VERSION — bvd 8.5");

/* ============================================================
   MAP INIT
============================================================ */
const map = L.map("map", { zoomControl: false })
  .setView([52.07, 4.35], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* ============================================================
   GPS TRACKING — GOOGLE STYLE CONE
============================================================ */

let tracking = false;
let firstJumpDone = false;
let smoothHeading = null;

/* Marker */
let gpsMarker = L.circleMarker([52.07, 4.35], {
  radius: 10,
  color: "#ffffff",
  weight: 2,
  fillColor: "#1a73e8",
  fillOpacity: 1
}).addTo(map);

/* Accuracy circle */
let gpsAccuracy = L.circle([52.07, 4.35], {
  radius: 0,
  color: "#1a73e8",
  fillOpacity: 0.15,
  weight: 1
}).addTo(map);

/* Google­size cone */
let directionCone = L.polygon([], {
  color: "#1a73e8",
  fillColor: "#1a73e8",
  fillOpacity: 0.22,
  weight: 0
}).addTo(map);

const CONE_NEAR = 22;
const CONE_FAR  = 70;
const CONE_LEN  = 95;

/* Smooth heading */
function updateSmoothHeading(raw) {
  if (smoothHeading === null) smoothHeading = raw;
  else smoothHeading = smoothHeading * 0.85 + raw * 0.15;
}

/* Draw cone */
function drawCone(latlng, hdg) {
  if (!hdg || !latlng) return directionCone.setLatLngs([]);

  const base = map.latLngToLayerPoint(latlng);
  const rad = d => d * Math.PI / 180;
  const a = rad(hdg - 90);
  const fwd = L.point(Math.cos(a), Math.sin(a));

  const A = base.add(L.point(-fwd.y, fwd.x).multiplyBy(CONE_NEAR / 2));
  const B = base.add(L.point(fwd.y, -fwd.x).multiplyBy(CONE_NEAR / 2));
  const C = base.add(fwd.multiplyBy(CONE_LEN).add(L.point(-fwd.y, fwd.x).multiplyBy(CONE_FAR / 2)));
  const D = base.add(fwd.multiplyBy(CONE_LEN).add(L.point(fwd.y, -fwd.x).multiplyBy(CONE_FAR / 2)));

  directionCone.setLatLngs([
    map.layerPointToLatLng(A),
    map.layerPointToLatLng(C),
    map.layerPointToLatLng(D),
    map.layerPointToLatLng(B)
  ]);
}

/* GPS update */
function updateGps(latlng, acc) {
  gpsMarker.setLatLng(latlng);
  gpsAccuracy.setLatLng(latlng).setRadius(acc);
  if (smoothHeading !== null) drawCone(latlng, smoothHeading);
}

/* Device orientation */
if (window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientationabsolute", e => {
    if (e.alpha != null) updateSmoothHeading(360 - e.alpha);
  });
  window.addEventListener("deviceorientation", e => {
    if (e.webkitCompassHeading) updateSmoothHeading(e.webkitCompassHeading);
  });
}

/* GPS found */
map.on("locationfound", e => {
  if (!tracking) return;
  updateGps(e.latlng, e.accuracy);
  if (!firstJumpDone) {
    map.setView(e.latlng, Math.max(map.getZoom(), 16), { animate: true });
    firstJumpDone = true;
  }
});

/* GPS error */
map.on("locationerror", e =>
  alert("GPS fout: " + e.message)
);

/* GPS button */
const gpsBtn = document.getElementById("gps-toggle");

gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);

  if (tracking) {
    firstJumpDone = false;
    map.locate({ watch: true, enableHighAccuracy: true });
  } else {
    map.stopLocate();
    directionCone.setLatLngs([]);
  }
});

/* Re-draw cone on zoom */
map.on("zoomend", () => {
  if (gpsMarker && smoothHeading !== null)
    drawCone(gpsMarker.getLatLng(), smoothHeading);
});
</script>
</body>
</html>
