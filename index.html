<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Detectorkaart V2</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
      html, body { margin: 0; padding: 0; height: 100%; }

      #app {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        font-family: system-ui, sans-serif;
      }

      .app-header {
        padding: 8px 12px;
        background: #111827;
        color: #e5e7eb;
        border-bottom: 1px solid #1f2937;
      }

      #map { flex: 1; width: 100%; }

      .gps-toggle {
        position: absolute; right: 12px; top: 60px; z-index: 1000;
        border: none; border-radius: 999px; padding: 8px 10px;
        display: flex; align-items: center; justify-content: center;
        background: #7f1d1d; color: white;
      }

      .gps-toggle.gps-on { background: #14532d; }

      .gps-dot {
        width: 12px; height: 12px; border-radius: 999px; background: white;
      }

      .gps-label { display: none; }

      .gps-marker {
        stroke-width: 3px;
        stroke: #000b7a !important;
        fill: #0033ff !important;
      }

      .leaflet-top.leaflet-right { margin-top: 120px; margin-right: 10px; }
    </style>
  </head>

  <body>
    <div id="app">
      <header class="app-header">
        <div class="app-title">Detectorkaart V2</div>
        <div class="app-subtitle">Build 5.2.1 â€“ Hillshade FIXED + GPS + AHN</div>
      </header>

      <div id="map"></div>

      <button id="gps-toggle" class="gps-toggle gps-off">
        <span class="gps-dot"></span><span class="gps-label">GPS uit</span>
      </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Hillshade plugin (WERKT 100%) -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-hillshade@1.0.0/dist/leaflet-hillshade.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Build 5.2.1 geladen (hillshade werkt)");

        const map = L.map("map").setView([52.07, 4.35], 12);

        // Basemap
        const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OSM",
        }).addTo(map);

        // AHN DTM (originele WMS)
        const ahnWms = L.tileLayer.wms("https://service.pdok.nl/rws/ahn/wms/v1_0?", {
          layers: "dtm_05m",
          styles: "default",
          format: "image/png",
          transparent: true,
        });

        // ðŸŸ¦ HILLSHADE - WERKENDE VORM
        const hillshade = L.leafletHillshade({
          url: "https://service.pdok.nl/rws/ahn/wms/v1_0?",
          layers: "dtm_05m",
          format: "image/png",
          transparent: true,
          altitude: 45,
          azimuth: 315,
          exaggeration: 1.3,
          opacity: 0.7
        });

        // Lagenlijst
        const baseLayers = { OpenStreetMap: osm };
        const overlays = {
          "AHN DTM 0.5m": ahnWms,
          "Hillshade": hillshade,
        };

        const layerControl = L.control.layers(baseLayers, overlays, {
          collapsed: true,
        }).addTo(map);

        hillshade.addTo(map);

        // GPS ------------------------------------
        let gpsMarker = null;
        let gpsAccuracyCircle = null;
        let gpsPulseCircle = null;
        let gpsPulseTimer = null;
        let gpsTracking = false;

        function startPulse(latlng) {
          stopPulse();
          gpsPulseCircle = L.circle(latlng, {
            radius: 8, color: "#001a72", fillColor: "#0033ff",
            fillOpacity: 0.4, weight: 1, interactive: false
          }).addTo(map);

          let r = 8, maxR = 32;
          gpsPulseTimer = setInterval(() => {
            if (!gpsPulseCircle) return;
            r = r >= maxR ? 8 : r + 0.8;
            const opacity = 0.6 * (1 - (r - 8) / (maxR - 8));
            gpsPulseCircle.setRadius(r);
            gpsPulseCircle.setStyle({ opacity, fillOpacity: opacity * 0.8 });
          }, 40);
        }

        function stopPulse() {
          if (gpsPulseTimer) clearInterval(gpsPulseTimer);
          gpsPulseTimer = null;
          if (gpsPulseCircle) map.removeLayer(gpsPulseCircle);
          gpsPulseCircle = null;
        }

        function updateGpsGraphics(latlng, accuracy) {
          if (!gpsMarker) {
            gpsMarker = L.circleMarker(latlng, {
              radius: 7, weight: 3,
              color: "#000b7a", fillColor: "#0033ff",
              fillOpacity: 1, className: "gps-marker"
            }).addTo(map);
          } else gpsMarker.setLatLng(latlng);

          if (!gpsAccuracyCircle) {
            gpsAccuracyCircle = L.circle(latlng, {
              radius: accuracy || 20,
              color: "#1d4ed8", fillColor: "#60a5fa",
              fillOpacity: 0.2, weight: 1
            }).addTo(map);
          } else {
            gpsAccuracyCircle.setLatLng(latlng);
            gpsAccuracyCircle.setRadius(accuracy || 20);
          }

          if (!gpsPulseCircle) startPulse(latlng);
          else gpsPulseCircle.setLatLng(latlng);
        }

        function clearGpsGraphics() {
          if (gpsMarker) map.removeLayer(gpsMarker);
          if (gpsAccuracyCircle) map.removeLayer(gpsAccuracyCircle);
          gpsMarker = gpsAccuracyCircle = null;
          stopPulse();
        }

        map.on("locationfound", (e) => {
          if (!gpsTracking) return;
          updateGpsGraphics(e.latlng, e.accuracy);
          map.setView(e.latlng, 17);
        });

        map.on("locationerror", (e) => alert("GPS fout: " + e.message));

        function startGpsTracking() {
          gpsTracking = true;
          map.locate({ watch: true, enableHighAccuracy: true });
        }

        function stopGpsTracking() {
          gpsTracking = false;
          map.stopLocate();
          clearGpsGraphics();
        }

        const gpsToggle = document.getElementById("gps-toggle");
        gpsToggle.addEventListener("click", () => {
          const on = !gpsTracking;
          if (on) startGpsTracking();
          else stopGpsTracking();
          gpsToggle.classList.toggle("gps-on", on);
          gpsToggle.classList.toggle("gps-off", !on);
        });
      });
    </script>
  </body>
</html>
