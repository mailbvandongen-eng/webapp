<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Detectorkaart V2 â€“ Build 7.0</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Cache uit -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      #app {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        font-family: system-ui, sans-serif;
      }

      .app-header {
        padding: 8px 12px;
        background: #111827;
        color: #e5e7eb;
        border-bottom: 1px solid #1f2937;
      }

      #map {
        flex: 1;
        width: 100%;
      }

      .gps-toggle {
        position: absolute;
        right: 12px;
        top: 60px;
        z-index: 1000;
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #f9fafb;
      }

      .gps-toggle.gps-off { background: #7f1d1d; }
      .gps-toggle.gps-on  { background: #14532d; }

      .gps-marker {
        stroke-width: 3px;
        stroke: #000b7a !important;
        fill: #0033ff !important;
      }

      .leaflet-top.leaflet-right {
        margin-top: 120px;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <header class="app-header">
        <div class="app-title">Detectorkaart V2</div>
        <div class="app-subtitle">Build 7.0 â€“ AMK + Mijn monumenten + Geomorf + AHN + GPS</div>
      </header>

      <div id="map"></div>

      <button id="gps-toggle" class="gps-toggle gps-off" type="button">
        <span class="gps-label">GPS uit</span>
      </button>
    </div>

    <!-- JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
      console.log("Detectorkaart V2 â€“ Build 7.0 geladen");

       <button id="gps-toggle" class="gps-toggle gps-off" type="button">
        <span class="gps-label">GPS uit</span>
      </button>
    </div>

    <!-- JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
      console.log("Detectorkaart V2 â€“ Build 7.0 geladen");

      document.addEventListener("DOMContentLoaded", () => {

        const map = L.map("map").setView([52.07, 4.35], 12);

        /* ---------------------------------------
           Basemaps
        ---------------------------------------- */
        const osm = L.tileLayer(
          // =========================================================
// BUILD 7 â€” DEEL 2
// Extra lagen: oppida, punten, toestemmingen, Romeinse verdedigingswerken
// =========================================================

// ----------------------------------
// Oppida
// ----------------------------------
const oppidaLayer = L.layerGroup();
fetch("data/oppida.geojson")
  .then(r=>r.json())
  .then(geo=>{
    L.geoJSON(geo,{
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:7,
        color:"#ff0000",
        fillColor:"#ff0000",
        fillOpacity:0.9
      }),
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(`<b>Oppidum</b><br>${p.Naam ?? ""}`);
      }
    }).addTo(oppidaLayer);
  });


// ----------------------------------
// Vondsten â€“ Punten
// ----------------------------------
const puntenLayer = L.layerGroup();
fetch("data/punten_custom.geojson")
  .then(r=>r.json())
  .then(geo=>{
    L.geoJSON(geo,{
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:5,
        color:"#7c3aed",   // paars
        fillColor:"#a78bfa",
        fillOpacity:0.9
      }),
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(
          `<b>${p.Naam ?? "Vondst"}</b><br>${p.Omschrijving ?? ""}`
        );
      }
    }).addTo(puntenLayer);
  });


// ----------------------------------
// Toestemmingen
// ----------------------------------
const toestLayer = L.layerGroup();
fetch("data/toestemmingen_custom.geojson")
  .then(r=>r.json())
  .then(geo=>{
    L.geoJSON(geo,{
      pointToLayer:(f,latlng)=>L.marker(latlng, {
        icon: L.divIcon({
          className: "toestemming-icon",
          html: "ðŸ”º",
          iconSize: [20,20],
          iconAnchor:[10,10]
        })
      }),
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(
          `<b>Toestemming</b><br>${p.Naam ?? ""}<br>${p.Omschrijving ?? ""}`
        );
      }
    }).addTo(toestLayer);
  });


// ----------------------------------
// Romeinse verdedigingswerken â€“ punten (donkerblauw)
// ----------------------------------
const romPtsLayer = L.layerGroup();
fetch("data/rom_def_points.geojson")
  .then(r=>r.json())
  .then(geo=>{
    L.geoJSON(geo,{
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:6,
        color:"#001f54",
        fillColor:"#003b99",
        fillOpacity:0.9
      }),
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(
          `<b>Romeins verdedigingspunt</b><br>${p.Naam ?? ""}`
        );
      }
    }).addTo(romPtsLayer);
  });


// ----------------------------------
// Romeinse verdedigingswerken â€“ lijnen (donkerblauw)
// ----------------------------------
const romLineLayer = L.layerGroup();
fetch("data/rom_def_lines.geojson")
  .then(r=>r.json())
  .then(geo=>{
    L.geoJSON(geo,{
      style:{
        color:"#001b44",
        weight:3,
        opacity:0.9
      },
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        l.bindPopup(
          `<b>Romeinse linie</b><br>${p.Naam ?? ""}`
        );
      }
    }).addTo(romLineLayer);
  });


// =========================================================
// LAYER CONTROL â€” Optie C: alles aanwezig, maar alleen
// AMK + jouw monumenten + vondsten staan standaard aan
// =========================================================

const baseLayers = {
  "OpenStreetMap": osm,
  "Google Hybrid": googleHybrid
};

const overlays = {
  "AHN DTM 0.5m": ahnWms,
  "Geomorfologie": geomorf,

  "AMK Monumenten": amkLayer,
  "Eigen monumenten": customMonLayer,
  "Vondsten (punten)": puntenLayer,
  "Toestemmingen": toestLayer,

  "Oppida": oppidaLayer,
  "Romeinse punten": romPtsLayer,
  "Romeinse lijnen": romLineLayer
};

L.control.layers(baseLayers, overlays, { collapsed:true }).addTo(map);


// =========================================================
// GPS
// =========================================================

let gpsMarker = null;
let gpsAccuracy = null;
let tracking = false;

function updateGps(latlng, acc) {
  if (!gpsMarker) {
    gpsMarker = L.circleMarker(latlng, {
      radius:7,
      weight:3,
      className:"gps-marker"
    }).addTo(map);
  } else gpsMarker.setLatLng(latlng);

  if (!gpsAccuracy) {
    gpsAccuracy = L.circle(latlng,{
      radius:acc,
      color:"#1d4ed8",
      fillOpacity:0.15
    }).addTo(map);
  } else {
    gpsAccuracy.setLatLng(latlng);
    gpsAccuracy.setRadius(acc);
  }
}

map.on("locationfound", e => {
  if (!tracking) return;
  updateGps(e.latlng, e.accuracy);
  map.setView(e.latlng, 17);
});

map.on("locationerror", e => alert("GPS fout: " + e.message));

const gpsBtn = document.getElementById("gps-toggle");
const gpsLabel = gpsBtn.querySelector(".gps-label");

gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);
  gpsBtn.classList.toggle("gps-off", !tracking);
  gpsLabel.textContent = tracking ? "GPS aan" : "GPS uit";

  if (tracking)
    map.locate({ watch:true, enableHighAccuracy:true });
  else {
    map.stopLocate();
    if (gpsMarker) map.removeLayer(gpsMarker);
    if (gpsAccuracy) map.removeLayer(gpsAccuracy);
    gpsMarker = null;
    gpsAccuracy = null;
  }
});

// ===============================================
// EINDE BUILD 7
// ===============================================

</script>
</body>
</html>
