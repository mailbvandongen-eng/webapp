<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Detectorkaart V2 – Build 7.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="madelinus.png" />

  <!-- Cache uit -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ============================================================
   BASIS & FUNDAMENT
   ============================================================ */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #ffffff;
  font-family: system-ui, sans-serif;
}

#app {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
}

#map {
  flex: 1;
  width: 100%;
}

/* Header (simpel maar functioneel) */
.app-header {
  padding: 8px 12px;
  background: #111827;
  color: #e5e7eb;
  border-bottom: 1px solid #1f2937;
}

.app-title {
  font-size: 16px;
  font-weight: 600;
}

.app-subtitle {
  font-size: 11px;
  color: #9ca3af;
}

/* ============================================================
   ZOOM CONTROLS – strak, modern, clean
   ============================================================ */

.leaflet-control-zoom {
  margin-top: 10px !important;
  margin-left: 10px !important;
}

.leaflet-control-zoom a {
  width: 38px !important;
  height: 38px !important;
  line-height: 38px !important;
  display: flex !important;
  align-items: center;
  justify-content: center;

  font-size: 20px !important;
  color: #111 !important;

  background: #ffffff !important;
  border-radius: 10px !important;
  border: none !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
}

.leaflet-control-zoom-in {
  margin-bottom: 6px !important;
}

.leaflet-control-zoom a:hover {
  background: #f3f4f6 !important;
}

/* ============================================================
   GPS KNOP — exact uitgelijnd + iOS stijl
   ============================================================ */

#gps-toggle {
  position: absolute;
  left: 10px;
  top: calc(10px + 38px + 6px + 38px + 6px); /* + en - + spacing */

  width: 38px;
  height: 38px;
  border-radius: 10px;

  background: #ffffff;
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;

  padding: 0;
  z-index: 9999;
}

#gps-toggle:hover {
  background: #f3f4f6;
}

/* GPS icoon – UIT (grijs) */
#gps-toggle .gps-icon {
  width: 22px;
  height: 22px;

  background-repeat: no-repeat;
  background-position: center;
  background-size: 22px 22px;

  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%236b7280' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

/* GPS icoon – AAN (blauw) */
#gps-toggle.gps-on .gps-icon {
  background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' fill='%232563EB' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z'/%3E%3C/svg%3E");
}

#gps-toggle.gps-on {
  box-shadow: 0 0 6px rgba(37,99,235,0.55);
}

/* ============================================================
   LAYER CONTROL — perfect uitgelijnd, clean
   ============================================================ */

.leaflet-top.leaflet-right {
  margin-top: 10px !important;
  margin-right: 10px !important;
}

.leaflet-control-layers {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

.leaflet-control-layers-toggle {
  width: 38px !important;
  height: 38px !important;
  border-radius: 10px !important;

  background: #ffffff !important;
  background-size: 22px 22px !important;
  background-position: center !important;

  border: none !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22) !important;
}

.leaflet-control-layers-toggle:hover {
  background: #f3f4f6 !important;
}

.leaflet-control-layers-expanded {
  background: #ffffff !important;
  border-radius: 10px !important;
  border: 1px solid #e5e7eb !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
  padding: 8px !important;
}

.leaflet-control-layers-list {
  background: #ffffff !important;
}

/* ============================================================
   OPACITY PANEL (AHN + Geomorf)
   ============================================================ */

.opacity-control {
  position: absolute;
  left: 10px;
  bottom: 10px;
  padding: 8px 10px;
  background: rgba(255,255,255,0.95);
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.22);
  font-size: 11px;
  color: #111827;
  z-index: 9999;
  min-width: 150px;
}

.opacity-control-title {
  font-weight: 600;
  font-size: 11px;
  margin-bottom: 4px;
}

.opacity-row {
  display: flex;
  flex-direction: column;
  margin-bottom: 4px;
}

.opacity-row label {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  margin-bottom: 2px;
}

.opacity-row input[type="range"] {
  width: 100%;
}
</style>
</head>

<body>
<div id="app">
  <header class="app-header">
    <div class="app-title">Detectorkaart V2</div>
    <div class="app-subtitle">
      Build 7.5 – AMK + eigen monumenten + vondsten + geomorf + AHN + GPS + opacity
    </div>
  </header>

  <div id="map"></div>

  <!-- GPS knop -->
  <button id="gps-toggle" class="gps-off" type="button">
    <div class="gps-icon"></div>
  </button>

  <!-- Opacity panel -->
  <div class="opacity-control">
    <div class="opacity-control-title">Lagen transparant</div>

    <div class="opacity-row">
      <label for="ahn-opacity">
        <span>AHN</span>
        <span id="ahn-opacity-value">70%</span>
      </label>
      <input id="ahn-opacity" type="range" min="0" max="100" value="70" />
    </div>

    <div class="opacity-row">
      <label for="geomorf-opacity">
        <span>Geomorf</span>
        <span id="geomorf-opacity-value">50%</span>
      </label>
      <input id="geomorf-opacity" type="range" min="0" max="100" value="50" />
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
console.log("Detectorkaart V2 – Build 7.5 geladen");

/* ============================================================
   KAART INIT
   ============================================================ */
const map = L.map("map").setView([52.07, 4.35], 12);

const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 19 }
).addTo(map);

const googleHybrid = L.tileLayer(
  "https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
  { maxZoom: 20 }
);

/* ============================================================
   PDOK
   ============================================================ */
const ahnWms = L.tileLayer.wms(
  "https://service.pdok.nl/rws/ahn/wms/v1_0?",
  { layers: "dtm_05m", format: "image/png", transparent: true }
);

const geomorf = L.tileLayer.wms(
  "https://service.pdok.nl/bzk/bro-geomorfologischekaart/wms/v2_0?",
  { layers: "geomorphological_area", format: "image/png", transparent: true }
);

/* Zet start-opacities */
ahnWms.setOpacity(0.7);
geomorf.setOpacity(0.5);

/* ============================================================
   LAAG: AMK
   ============================================================ */
const amkLayer = L.layerGroup();
fetch("data/amk_monumenten.topojson")
  .then(r => r.json())
  .then(topo => {
    const name = Object.keys(topo.objects)[0];
    const geo = topojson.feature(topo, topo.objects[name]);
    const layer = L.geoJSON(geo, {
      style: { color: "#a855f7", weight: 1, fillOpacity: 0.25 }
    });
    amkLayer.addLayer(layer);
  });

/* ============================================================
   LAAG: Eigen monumenten
   ============================================================ */
const customMonLayer = L.layerGroup();
fetch("data/monumenten_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      style: {
        color: "#9333ea",
        fillColor: "#c4b5fd",
        fillOpacity: 0.35,
        weight: 1.2
      }
    });
    customMonLayer.addLayer(layer);
  });

/* ============================================================
   LAAG: Vondsten
   ============================================================ */
const puntenLayer = L.layerGroup();
fetch("data/punten_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (f, latlng) =>
        L.circleMarker(latlng, {
          radius: 5,
          color: "#7c3aed",
          fillColor: "#a78bfa",
          fillOpacity: 0.9
        })
    });
    puntenLayer.addLayer(layer);
  });

/* ============================================================
   LAAG: Toestemmingen
   ============================================================ */
const toestLayer = L.layerGroup();
function makeToestIcon(zoom) {
  const size = Math.max(12, Math.min(22, zoom * 1.2));
  return L.divIcon({
    html: `<div style="font-size:${size}px;color:#22c55e;font-weight:bold;text-shadow:0 0 2px black;">✔</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2]
  });
}

fetch("data/toestemmingen_custom.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (f, latlng) =>
        L.marker(latlng, { icon: makeToestIcon(map.getZoom()) })
    });
    toestLayer.addLayer(layer);

    map.on("zoomend", () =>
      layer.eachLayer(m => m.setIcon(makeToestIcon(map.getZoom())))
    );
  });

/* ============================================================
   LAAG: Romeinse punten + lijnen
   ============================================================ */
const romPtsLayer = L.layerGroup();
fetch("data/rom_def_points.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      pointToLayer: (f, latlng) =>
        L.circleMarker(latlng, {
          radius: 6,
          color: "#001f54",
          fillColor: "#003b99",
          fillOpacity: 0.9
        })
    });
    romPtsLayer.addLayer(layer);
  });

const romLineLayer = L.layerGroup();
fetch("data/rom_def_lines.geojson")
  .then(r => r.json())
  .then(geo => {
    const layer = L.geoJSON(geo, {
      style: { color: "#001b44", weight: 3, opacity: 0.9 }
    });
    romLineLayer.addLayer(layer);
  });

/* ============================================================
   LAYER SELECTOR
   ============================================================ */
const baseLayers = {
  "OpenStreetMap": osm,
  "Google Hybrid": googleHybrid
};

const overlays = {
  "AHN 0.5m": ahnWms,
  "Geomorfologie": geomorf,
  "AMK Monumenten": amkLayer,
  "Eigen monumenten": customMonLayer,
  "Vondsten": puntenLayer,
  "Toestemmingen": toestLayer,
  "Romeinse punten": romPtsLayer,
  "Romeinse lijnen": romLineLayer
};

L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

/* ============================================================
   GPS (Optie B)
   ============================================================ */
let tracking = false;

let gpsMarker = L.circleMarker([52.07, 4.35], {
  radius: 6,
  color: "#1a73e8",
  fillColor: "#1a73e8",
  fillOpacity: 1,
  weight: 2
}).addTo(map);

let gpsAccuracy = L.circle([52.07, 4.35], {
  radius: 0,
  color: "#1a73e8",
  fillOpacity: 0.15
}).addTo(map);

function updateGps(latlng, acc) {
  gpsMarker.setLatLng(latlng);
  gpsAccuracy.setLatLng(latlng);
  gpsAccuracy.setRadius(acc);
}

map.on("locationfound", (e) => {
  if (!tracking) return;
  updateGps(e.latlng, e.accuracy);
});

const gpsBtn = document.getElementById("gps-toggle");
gpsBtn.addEventListener("click", () => {
  tracking = !tracking;
  gpsBtn.classList.toggle("gps-on", tracking);

  if (tracking) {
    map.locate({ watch: true, enableHighAccuracy: true });
  } else {
    map.stopLocate();
  }
});

/* ============================================================
   OPACITY SLIDERS – AHN & Geomorf
   ============================================================ */
const ahnSlider = document.getElementById("ahn-opacity");
const geomSlider = document.getElementById("geomorf-opacity");
const ahnValue = document.getElementById("ahn-opacity-value");
const geomValue = document.getElementById("geomorf-opacity-value");

if (ahnSlider) {
  ahnSlider.addEventListener("input", (e) => {
    const v = Number(e.target.value);
    ahnWms.setOpacity(v / 100);
    if (ahnValue) ahnValue.textContent = `${v}%`;
  });
}

if (geomSlider) {
  geomSlider.addEventListener("input", (e) => {
    const v = Number(e.target.value);
    geomorf.setOpacity(v / 100);
    if (geomValue) geomValue.textContent = `${v}%`;
  });
}
</script>

</body>
</html>
